# Bybit 분할 진입/청산 전략 (Adaptive Split Entry/Exit Strategy)

> **작성일**: 2025-10-21
> **버전**: 2.0 (Draft)
> **상태**: 검토 중
> **최종 수정**: 시장 상황별 전략 분기 추가

## 📌 전략 개요

볼린저 밴드 상단/하단 돌파 시 **시장 상황에 따라 다른 전략**을 사용:

### 🎯 전략 분기

```
시장 상황 분석
    ↓
┌─────────────┴─────────────┐
│                           │
극단적 추세장              횡보장 / 일반 추세장
(extremeBullish/Bearish)   (ranging / bullish / bearish)
│                           │
전략 A: 추세 추종           전략 B: 역추세 + 물타기
- BB 돌파 방향으로 진입     - BB 돌파 반대로 진입
- 추세 확인 후 추가 진입    - 평균회귀 베팅 + 물타기
- 큰 수익 추구              - 빠른 익절 우선
```

**핵심 아이디어**:
- **극단적 추세**: 강한 모멘텀이 지속되므로 추세를 따라감
- **횡보/일반 추세**: 과도한 돌파는 평균으로 회귀하는 경향 활용

---

## 🔍 시장 상황 판단 기준

현재 구현된 `MarketAnalyzer`의 5가지 시장 조건을 3개 그룹으로 분류:

| 시장 조건 | 조건 | 적용 전략 |
|----------|------|----------|
| **극단적 강세** (extremeBullish) | RSI > 65, 강한 상승 모멘텀, EMA 정배열 | 전략 A (추세 추종) |
| **극단적 약세** (extremeBearish) | RSI < 35, 강한 하락 모멘텀, EMA 역배열 | 전략 A (추세 추종) |
| **일반 강세** (bullish) | RSI 50-65, 약한~중간 상승 | 전략 B (역추세) |
| **횡보** (ranging) | RSI 40-60, 좁은 BB 폭 | 전략 B (역추세) |
| **일반 약세** (bearish) | RSI 35-50, 약한~중간 하락 | 전략 B (역추세) |

**판단 주기**: 5분마다 시장 재분석

---

## ⚡ 전략 A: 극단적 추세장 - 추세 추종 전략

**적용 시장**: extremeBullish, extremeBearish

**기본 원칙**: BB 돌파 방향으로 진입 (브레이크아웃 추종)

### 초기 신호 감지
```
극단적 강세장:
- BB 상단 돌파 → 롱 진입 (추세 따라가기)

극단적 약세장:
- BB 하단 돌파 → 숏 진입 (추세 따라가기)
```

### 1차 진입 (5% 포지션)

**필수 조건**:
- ✅ BB 돌파 (강세: 상단 돌파 → 롱 / 약세: 하단 돌파 → 숏)
- ✅ RSI가 극단 구간 (강세: RSI > 60 / 약세: RSI < 40)
- ✅ 거래량 ≥ 평균 거래량 × 1.2
  - 이유: 거래량 동반해야 진짜 돌파
- ✅ EMA9가 추세 방향과 일치
  - 강세: EMA9 상승 중
  - 약세: EMA9 하락 중

### 2차 진입 (5% 추가, 총 10%)

**추가 조건**:
- ✅ 1차 진입 후 **최소 2분 경과**
  - 이유: 즉각 반응 방지, 추세 관찰
- ✅ 가격이 BB 밴드 밖에서 유지 중
  - 이유: 되돌림 없음 = 추세 지속
- ✅ 1차 진입 평균가 대비 **+0.15% 이상** 수익 중
  - 이유: 추세 확인됨
- ✅ ATR(Average True Range) 증가 또는 유지
  - 이유: 변동성 확대 = 강한 모멘텀

### 3차 진입 (10% 추가, 총 20%)

**강력한 확신 조건**:
- ✅ 2차 진입 후 **최소 3분 경과**
- ✅ 전체 평균가 대비 **+0.3% 이상** 수익 중
- ✅ RSI가 여전히 극단 구간 유지
  - 강세: RSI ≥ 55
  - 약세: RSI ≤ 45
- ✅ 포지션 방향으로 **캔들 2개 이상 연속**
  - 강세 롱: 양봉 2개 이상 또는 고점 상승 중
  - 약세 숏: 음봉 2개 이상 또는 저점 하락 중

**최대 노출**: **20%**

### 손절 조건 (전략 A)

**개별 진입별 손절**:
```
1차 진입: -0.4% 손절 (5% 포지션만)
2차 진입: -0.5% 손절 (추가 5%만)
3차 진입: -0.6% 손절 (추가 10%만)
```

**전체 포지션 긴급 손절**:
- ❌ 전체 평균가 대비 **-0.8% 이하**
- ❌ BB 밴드 중앙선 이탈
  - 예: 롱 포지션인데 BB 중앙선 아래로 하락
- ❌ RSI 급격한 반전
  - 예: 강세 롱인데 RSI < 45

---

## 🔄 전략 B: 횡보/일반 추세장 - 역추세 + 물타기 전략

**적용 시장**: ranging, bullish, bearish

**기본 원칙**: BB 돌파 반대 방향으로 진입 (평균회귀 베팅)

### 초기 신호 감지
```
모든 경우:
- BB 상단 돌파 → 숏 진입 (과열, 되돌림 예상)
- BB 하단 돌파 → 롱 진입 (과매도, 반등 예상)
```

### 1차 진입 (5% 포지션)

**필수 조건**:
- ✅ BB 돌파 (상단 → 숏 / 하단 → 롱)
- ✅ RSI가 과도한 구간
  - BB 상단 돌파 시: RSI > 65 (과매수)
  - BB 하단 돌파 시: RSI < 35 (과매도)
- ✅ 거래량 ≥ 평균 거래량 × 1.0
  - 이유: 과도한 움직임 확인
- ✅ EMA9/21이 평평하거나 약한 방향성
  - 이유: 강한 추세 아님 확인

### 2차 진입 (5% 추가, 총 10%) - 물타기

**물타기 조건** (예상이 빗나갔을 때):
- ✅ 1차 진입 후 **최소 2분 경과**
- ✅ 가격이 계속 불리한 방향으로 진행 중
  - 숏 포지션: 가격이 계속 상승 (+0.2% 이상)
  - 롱 포지션: 가격이 계속 하락 (-0.2% 이상)
- ✅ 1차 진입 평균가 대비 **-0.1% ~ -0.3% 손실** 중
  - 이유: 약간의 손실만 허용 (깊은 손실 전에 평단가 개선)
- ✅ RSI가 여전히 과도한 구간 유지
  - 숏: RSI > 65
  - 롱: RSI < 35
- ✅ BB 폭이 과도하게 확대되지 않음
  - 이유: 진짜 강한 추세 시작 아님 확인

### 3차 진입 (10% 추가, 총 20%) - 최종 물타기

**최종 물타기 조건** (마지막 기회):
- ✅ 2차 진입 후 **최소 3분 경과**
- ✅ 전체 평균가 대비 **-0.3% ~ -0.6% 손실** 중
- ✅ RSI가 극단적 과열/과냉 (70+ 또는 30-)
  - 이유: 이 정도면 반드시 되돌림 올 것이라는 강한 확신
- ✅ 가격이 BB 밴드 2σ 이상 벗어남
  - 이유: 통계적으로 평균으로 회귀할 확률 95%+
- ✅ 횡보장이거나 약한 추세 유지 (MarketCondition 재확인)
  - 이유: 극단적 추세로 전환되지 않음 확인

**최대 노출**: **20%**

**⚠️ 중요 제한**:
- 전체 평균가 대비 **-0.8% 이상** 손실 시 3차 진입 **금지**
- 시장 조건이 극단적 추세로 전환되면 즉시 전체 손절

### 청산 조건 (전략 B)

**목표**: 빠른 익절 우선 (평단가 개선됐으므로 작은 반전에도 수익)

#### 레버리지 5배

| 수익률 | 청산 비율 | 누적 청산 | 남은 포지션 | 비고 |
|--------|----------|----------|------------|------|
| **0.3%** | 30% | 30% | 70% | 빠른 이익 실현 (물타기했으므로 낮은 목표) |
| **0.6%** | 40% | 70% | 30% | 대부분 청산 |
| **1.0%** | 20% | 90% | 10% | 안전 확보 |
| **1.5%** | 10% | 100% | 0% | 전체 청산 |

#### 레버리지 10배

| 수익률 | 청산 비율 | 누적 청산 | 남은 포지션 |
|--------|----------|----------|------------|
| **0.4%** | 35% | 35% | 65% |
| **0.8%** | 40% | 75% | 25% |
| **1.2%** | 15% | 90% | 10% |
| **2.0%** | 10% | 100% | 0% |

#### 레버리지 15배

| 수익률 | 청산 비율 | 누적 청산 | 남은 포지션 |
|--------|----------|----------|------------|
| **0.5%** | 40% | 40% | 60% |
| **1.0%** | 40% | 80% | 20% |
| **1.5%** | 15% | 95% | 5% |
| **2.5%** | 5% | 100% | 0% |

**청산 철학**:
- 전략 B는 물타기로 평단가 개선됨
- 따라서 작은 반전에도 수익 가능
- 초반에 대부분 청산하여 리스크 최소화

### 손절 조건 (전략 B)

**개별 진입별 손절** (전략 A보다 엄격):
```
1차 진입: -0.3% 손절 (5% 포지션만)
2차 진입: -0.5% 손절 (전체 10% 청산)
3차 진입: -0.7% 손절 (전체 20% 청산)
```

**전체 포지션 긴급 손절** (가장 중요!):
- ❌ 전체 평균가 대비 **-1.0% 이하**
  - 이유: 물타기 전략이므로 손실 한도 엄격히 관리
- ❌ 시장 조건이 **극단적 추세로 전환**
  - MarketAnalyzer가 extremeBullish/Bearish 감지 시
  - 예: ranging에서 숏 진입 → extremeBullish로 전환 → 즉시 손절
- ❌ BB 밴드 반대편 완전 돌파
  - 예: BB 상단에서 숏 진입 → BB 하단까지 하락 → 즉시 손절
- ❌ 레버리지 10배 이상 시 **-0.8% 이하**
  - 이유: 고레버리지는 청산 위험

**⚠️ 물타기 리스크 관리**:
- 3차 진입까지 했는데도 손실이 확대되면 → **즉시 전체 청산**
- 절대 4차, 5차 진입은 하지 않음 (무한 물타기 방지)

---

## 💰 공통: 분할 매도 전략 (전략 A 전용)

**적용**: 전략 A (추세 추종)만 해당 (전략 B는 위 섹션 참조)

### 레버리지 5배

| 수익률 | 청산 비율 | 누적 청산 | 남은 포지션 | 비고 |
|--------|----------|----------|------------|------|
| 0.4%   | 20%      | 20%      | 80%        | 빠른 이익 실현 |
| 0.8%   | 30%      | 50%      | 50%        | 원금 회수 |
| 1.2%   | 30%      | 80%      | 20%        | 안전 확보 |
| 1.8%   | 20%      | 100%     | 0%         | 전체 청산 |

### 레버리지 10배

| 수익률 | 청산 비율 | 누적 청산 | 남은 포지션 |
|--------|----------|----------|------------|
| 0.5%   | 25%      | 25%      | 75%        |
| 1.0%   | 35%      | 60%      | 40%        |
| 1.5%   | 25%      | 85%      | 15%        |
| 2.2%   | 15%      | 100%     | 0%         |

### 레버리지 15배

| 수익률 | 청산 비율 | 누적 청산 | 남은 포지션 |
|--------|----------|----------|------------|
| 0.6%   | 30%      | 30%      | 70%        |
| 1.2%   | 40%      | 70%      | 30%        |
| 2.0%   | 20%      | 90%      | 10%        |
| 3.0%   | 10%      | 100%     | 0%         |

**수익률 산정 근거**:
```
Bybit 수수료:
- Maker: -0.025% (리베이트)
- Taker: 0.055%

왕복 비용: 약 0.08% (수수료) + 0.05% (슬리피지) = 0.13%
→ 0.4% 수익 시 순수익 약 0.27%
```

---

## 📈 트레일링 스톱 (공통)

**적용 시점**: 50% 이상 청산 후 (두 전략 모두 동일)

**로직**:
```
남은 포지션에 트레일링 스톱 적용:
- 최고 수익률 대비 -0.3% 하락 시 청산
- 예: 최고 1.5% 도달 → 1.2%로 하락 시 남은 포지션 청산
```

**목적**: 수익 보호 + 큰 수익 기회 포착 균형

---

## 📊 시나리오 예시

### 시나리오 1: 전략 A - 성공적인 추세 추종 (극단적 강세, 레버리지 10배)

**시장 상황**: extremeBullish (RSI 68, 강한 상승)

| 시간  | 가격변화 | 액션           | 포지션 | 평균수익 | 비고 |
|-------|----------|----------------|--------|----------|------|
| 00:00 | BB 상단 돌파 | 1차 롱 진입 5% | 5%     | 0%       | BB 돌파 방향 진입 |
| 00:02 | +0.2%    | 홀딩           | 5%     | +0.2%    | 추세 확인 중 |
| 00:03 | +0.4%    | 홀딩           | 5%     | +0.4%    | |
| 00:04 | +0.5%    | 25% 청산 + 2차 롱 5% | 8.75%  | +0.38%   | 2분 경과, 추세 지속 |
| 00:07 | +0.8%    | 홀딩           | 8.75%  | +0.7%    | |
| 00:09 | +1.0%    | 35% 청산       | 5.7%   | +1.0%    | |
| 00:10 | +1.2%    | 3차 롱 10%     | 15.7%  | +0.76%   | 3분 경과, 강한 확신 |
| 00:13 | +1.5%    | 25% 청산       | 11.8%  | +1.3%    | |
| 00:16 | +2.0%    | 트레일링 작동  | 0%     | +1.6%    | 전체 청산 |

**최종 결과**: 평균 수익률 **+1.6%** (최대 노출 15.7%)

---

### 시나리오 2: 전략 B - 성공적인 역추세 + 물타기 (횡보, 레버리지 10배)

**시장 상황**: ranging (RSI 50-60, BB 폭 좁음)

| 시간  | 가격변화 | 액션           | 포지션 | 평균수익 | 비고 |
|-------|----------|----------------|--------|----------|------|
| 00:00 | BB 상단 돌파 | 1차 숏 진입 5% | 5%     | 0%       | 역추세 베팅 |
| 00:01 | +0.15%   | 홀딩           | 5%     | -0.15%   | 예상과 다르게 상승 |
| 00:02 | +0.25%   | 홀딩           | 5%     | -0.25%   | 물타기 대기 |
| 00:03 | +0.30%   | 2차 숏 진입 5% | 10%    | -0.15%   | 물타기 (평단가 개선) |
| 00:04 | +0.35%   | 홀딩           | 10%    | -0.175%  | 반전 대기 |
| 00:05 | +0.25%   | 홀딩           | 10%    | -0.075%  | 반전 시작! |
| 00:06 | +0.15%   | 홀딩           | 10%    | +0.025%  | 수익 전환 |
| 00:07 | +0.10%   | 35% 청산       | 6.5%   | +0.15%   | 0.4% 목표 근접, 일부 청산 |
| 00:08 | 0%       | 40% 청산       | 3.9%   | +0.6%    | 대부분 청산 |
| 00:09 | -0.10%   | 15% 청산       | 3.3%   | +1.0%    | |
| 00:10 | -0.20%   | 전체 청산      | 0%     | +0.8%    | 빠른 익절 완료 |

**최종 결과**: 평균 수익률 **+0.8%** (최대 노출 10%, 물타기 1회)
**핵심**: 평단가 개선으로 작은 반전에도 수익!

---

### 시나리오 3: 전략 B - 실패 케이스 (횡보 → 극단적 추세 전환)

**시장 상황**: ranging → extremeBullish로 급변

| 시간  | 가격변화 | 액션           | 포지션 | 평균수익 | 비고 |
|-------|----------|----------------|--------|----------|------|
| 00:00 | BB 상단 돌파 | 1차 숏 진입 5% | 5%     | 0%       | ranging 판단 |
| 00:02 | +0.25%   | 홀딩           | 5%     | -0.25%   | |
| 00:03 | +0.35%   | 2차 숏 진입 5% | 10%    | -0.15%   | 물타기 |
| 00:05 | +0.55%   | 홀딩           | 10%    | -0.35%   | 계속 상승... |
| 00:06 | +0.75%   | **시장 조건 재분석** | 10% | -0.55% | extremeBullish 감지! |
| 00:06 | +0.75%   | **전체 긴급 손절** | 0% | **-0.55%** | 추세 전환, 즉시 손절 |

**최종 결과**: 손실 **-0.55%** (시장 전환 감지로 큰 손실 방지)
**핵심**: 시장 조건 모니터링으로 치명적 손실 회피!

---

### 시나리오 4: 전략 A - False Breakout (손실 제한)

**시장 상황**: extremeBullish로 판단했으나 False Signal

| 시간  | 가격변화 | 액션           | 포지션 | 평균수익 |
|-------|----------|----------------|--------|----------|
| 00:00 | BB 상단 돌파 | 1차 롱 진입 5% | 5%     | 0%       |
| 00:01 | +0.1%    | 홀딩           | 5%     | +0.1%    |
| 00:02 | -0.1%    | 홀딩           | 5%     | -0.1%    |
| 00:03 | -0.3%    | 홀딩           | 5%     | -0.3%    |
| 00:04 | -0.4%    | 손절           | 0%     | -0.4%    |

**최종 결과**: 손실 **-0.4%** (1차 진입만, 최소 손실)

---

## 🔧 구현 시 핵심 포인트

### 1. 시장 상황 감지 및 전략 선택

```dart
class SplitEntryStrategy {
  final MarketAnalyzer marketAnalyzer;

  TradingSignal? checkSignal(MarketData data) {
    // 1. 시장 상황 분석
    final condition = marketAnalyzer.analyzeMarket(data);

    // 2. 전략 선택
    if (condition == MarketCondition.extremeBullish ||
        condition == MarketCondition.extremeBearish) {
      return _checkTrendFollowingSignal(data, condition);
    } else {
      return _checkCounterTrendSignal(data, condition);
    }
  }
}
```

### 2. 상태 관리

```dart
class PositionEntry {
  final double price;
  final double quantity;
  final DateTime entryTime;
  final int entryLevel; // 1, 2, 3
  final StrategyType strategyType; // trendFollowing, counterTrend
}

class PositionState {
  final List<PositionEntry> entries;
  final StrategyType currentStrategy;
  final MarketCondition marketConditionAtEntry; // 진입 시 시장 상황 저장

  double get averagePrice => /* 가중 평균 계산 */;
  double get totalSize => entries.fold(0, (sum, e) => sum + e.quantity);
  double get unrealizedPnlPercent => /* 현재가 대비 손익률 */;
}
```

### 3. 시장 조건 모니터링 (매우 중요!)

```dart
// 전략 B (역추세)에서 필수!
void _monitorMarketCondition() {
  if (currentStrategy == StrategyType.counterTrend) {
    final newCondition = marketAnalyzer.analyzeMarket(latestData);

    // 극단적 추세로 전환 감지
    if (newCondition == MarketCondition.extremeBullish ||
        newCondition == MarketCondition.extremeBearish) {

      // 역추세 포지션과 충돌하면 즉시 손절
      if (_isConflicting(currentPosition, newCondition)) {
        _emergencyCloseAll();
        Logger.warning('시장 조건 전환 감지: ${marketConditionAtEntry} → $newCondition, 긴급 손절');
      }
    }
  }
}
```

### 4. 물타기 안전 장치

```dart
bool _canAddCounterTrendPosition(int level, double unrealizedPnl) {
  // 최대 3회만 허용
  if (level > 3) return false;

  // 손실 한도 체크
  if (unrealizedPnl < -0.008) { // -0.8%
    Logger.warning('손실 한도 초과, 추가 진입 금지');
    return false;
  }

  // 시장 조건이 극단적 추세로 전환되지 않았는지 확인
  final currentCondition = marketAnalyzer.analyzeMarket(latestData);
  if (currentCondition == MarketCondition.extremeBullish ||
      currentCondition == MarketCondition.extremeBearish) {
    Logger.warning('극단적 추세 전환, 추가 진입 금지');
    return false;
  }

  return true;
}
```

### 5. ATR 계산 (추가 필요)

```dart
double calculateATR(List<Kline> klines, {int period = 14}) {
  final trs = <double>[];

  for (int i = 1; i < klines.length; i++) {
    final high = double.parse(klines[i].high);
    final low = double.parse(klines[i].low);
    final prevClose = double.parse(klines[i - 1].close);

    final tr = max(
      high - low,
      max(
        (high - prevClose).abs(),
        (low - prevClose).abs(),
      ),
    );
    trs.add(tr);
  }

  // 단순 이동 평균
  return trs.skip(trs.length - period).reduce((a, b) => a + b) / period;
}
```

### 6. 분할 청산 로직

```dart
Future<void> _executePartialClose(double targetPnl, double closePercent) async {
  final currentPosition = await bybitRepository.getPosition(symbol);
  final closeQty = currentPosition.size * closePercent;

  // Bybit 최소 주문 단위 체크
  if (closeQty < minOrderQty) {
    Logger.debug('청산 수량이 최소 단위 미만, 다음 구간까지 대기');
    return;
  }

  // 청산 주문
  final result = await bybitRepository.createOrder(
    symbol: symbol,
    side: currentPosition.side == 'Buy' ? 'Sell' : 'Buy',
    orderType: 'Market',
    qty: closeQty,
    reduceOnly: true,
  );

  // 진입 기록 업데이트
  _updateEntriesAfterPartialClose(closePercent);
}
```

---

## 🧪 테스트 요구사항

### 1. 백테스트 (필수!)

**데이터**: 최소 3개월, 다양한 시장 상황 포함
- 극단적 강세장 기간
- 극단적 약세장 기간
- 횡보장 기간
- 추세 전환 기간 (ranging → extreme)

**측정 지표**:
```
전체 전략:
- 총 승률
- 평균 손익비 (Profit Factor)
- 최대 낙폭 (MDD)
- 샤프 비율

전략별:
- 전략 A 승률 vs 전략 B 승률
- 각 전략의 평균 수익/손실
- 물타기 성공률 (전략 B)
- 시장 조건 전환 감지 정확도
```

### 2. Testnet 검증

**테스트 기간**: 최소 2주

**확인 사항**:
- 시장 조건 분석 정확도
- 전략 선택 적절성
- 물타기 타이밍
- 긴급 손절 작동
- API 호출 성공률
- WebSocket 안정성

### 3. 소액 실전 테스트

**초기 자금**: 최소 금액 (예: $100)
**레버리지**: 5배 이하로 제한
**기간**: 최소 2주

**모니터링**:
- 실시간 시장 조건 판단 로그
- 각 진입/청산 결정 이유 기록
- 긴급 손절 발생 빈도
- 물타기 후 수익률 분포

---

## ⚠️ 리스크 관리 체크리스트

### 전략 A (추세 추종)

- [ ] False breakout 시 빠른 손절 (-0.4%)
- [ ] 최대 노출 20% 제한
- [ ] 추세 반전 감지 시 즉시 청산
- [ ] 레버리지별 적정 목표 수익률 준수

### 전략 B (역추세 + 물타기) - 특히 중요!

- [ ] 최대 3회까지만 물타기 (무한 물타기 방지)
- [ ] 전체 손실 한도 -1.0% 엄수
- [ ] 시장 조건 5분마다 재분석
- [ ] 극단적 추세 전환 시 즉시 손절
- [ ] 레버리지 10배 이상 시 손실 한도 -0.8%
- [ ] 물타기 간격 최소 2분 (충동적 진입 방지)
- [ ] BB 폭 급격한 확대 시 물타기 중단

### 공통

- [ ] testnet에서 충분한 검증 후 mainnet 전환
- [ ] 초기에는 레버리지 5배 이하 사용
- [ ] 로그 완벽히 기록 (디버깅 및 개선용)
- [ ] 청산가 여유 확보 (레버리지 낮게)

---

## 🚀 다음 단계

1. ✅ 전략 설계 문서 작성 (완료)
2. ⏳ 파라미터 최종 검토 및 조정
3. ⏳ `SplitEntryStrategy` 클래스 구현
4. ⏳ `BybitTradingProvider`에 통합
5. ⏳ 백테스트 시스템 구현
6. ⏳ Testnet 검증 (최소 2주)
7. ⏳ 소액 실전 테스트
8. ⏳ Mainnet 점진적 확대

---

## 📝 변경 이력

**v2.0 (2025-10-21)**:
- 시장 상황별 전략 분기 추가
- 전략 A: 극단적 추세 - 추세 추종
- 전략 B: 횡보/일반 추세 - 역추세 + 물타기
- 물타기 안전장치 강화
- 시장 조건 모니터링 로직 추가

**v1.0 (2025-10-21)**:
- 초기 설계 (단일 전략)

---

**문서 끝**
